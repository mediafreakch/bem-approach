<style lang="less" src="./style/index.less"></style>

<template>

  <h1>Konto wiederherstellen</h1>
  <p>Hier können Sie die E-Mail-Adresse Ihres Kontos aktualisieren.
    Abschliessend senden wir Ihnen ein temporäres Passwort.</p>
  <form id="formOldEmail" @submit.prevent="submit" autocomplete="off">
    <r-form-item
        variant="text"
        label="Letzte E-Mail-Adresse oder Benutzername"
        input-id="userOrEmail"
        type="text"
        validation-type="['required']"
        validation-message="['Bitte füllen Sie dieses Feld aus um weiterzufahren.']"
        icon="spinner"
        :retrieving-data="userOrEmailIsRetrievingData"
        :readonly="userOrEmailIsReadonly"
        v-ref:userOrEmail
        @value-change="inputValueChanged"
        @input-enter="handleEnterCase"
        @input-blur="userIdChanged"
    ></r-form-item>

    <div v-if="isPassportSubmitted">
      <r-alert type="success" icon="checkmark">
        Der Scan Ihrer ID / Ihres Passes wurde erfolgreich an unseren Kundendienst
        übermittelt. Sobald wir die Angaben bestätigen können, senden wir Ihnen
        eine E-Mail zur Wiederherstellung Ihres Kontos zu.
      </r-alert>
    </div>

    <div v-if="isLandline && !isPassportSubmitted">
      <r-alert type="info">Um Sie als Inhaber dieses Kontos bestätigen zu können,
        benötigen wir ein Bild ihres Reisepasses oder ID.</r-alert>
      <r-file-upload
          input-id="pass"
          label="Foto machen"
          @image-loaded="imageLoaded"
      ></r-file-upload>
    </div>
    <div v-if="isMobile">
      <r-alert type="info">
        Wir haben eine Mobilnummer zu dieser E-Mail gefunden. Zur Verifizierung
        dieser Nummer senden wir Ihnen eine SMS mit einem Code.
      </r-alert>
      <p><strong>+41 XX XXX {{formattedPhonePart}}</strong></p>
    </div>
    <div v-if="isMobile && isSmsCodeRequested">
      <r-form-item
          variant="text"
          label="Verifizierungscode"
          input-id="verificationCode"
          type="text"
          validation-type="['required']"
          validation-message="['Bitte füllen Sie dieses Feld aus um weiterzufahren.']"
          :vuexNameSpace="formVerify"
          @value-change="inputValueChanged"
      ></r-form-item>
    </div>
    <r-alert v-if="isError" type="danger">{{errorMessage}}</r-alert>
    <button
        id="submit"
        v-if="!isPassportSubmitted"
        @click.prevent="tryToSendForm"
        class="btn btn-primary btn-block btn-iconed"
        type="button"
    >
      {{submitWording}}
      <span v-if="isRequestSmsRetrievingData">&nbsp;<span class="icon icon-spinner rotating"></span></span>
      <!--<span-->
      <!--:class="{'rotating': true}"-->
      <!--&gt;&#xE637;</span>-->
    </button>
    <a v-if="isMobile" href="#" @click.prevent="switchToLandlineProcess">Die angezeigte Telefonnummer ist nicht Ihre?</a>
  </form>

  <!--<button @click.prevent="debug">debug</button>-->

</template>

<script>

  var
      icon = require('ricardo-element_icon'),
      formElement = require('ricardo-element_form-elements'),
      formItem = formElement.components.formItem,
      fileUpload = formElement.components.fileUpload,
      alert = require('ricardo-component_alert'),
      clearfix = require('ricardo-element_utils'),
      vuexActions = require('./vuex/actions.js'),
      vuexGetters = require('./vuex/getters'),
      api = require('./js/api');

  console.log(vuexActions);

  module.exports = {
    components: {
      'r-form-item': formItem,
      'r-alert': alert,
      'r-file-upload': fileUpload
    },
    vuex: {
      getters: vuexGetters,
      actions: vuexActions
    },
    mixins: [
      api
    ],
    computed: {
      debug: function() {
        return this.actions;
      },
      submitWording: function() {
        if(this.isLandline){
          return 'Anfrage senden';
        } else if (this.isMobile) {
          if(this.isSmsCodeRequested) {
            return 'Bestätigen'
          } else {
            return 'SMS mit Code senden';
          }
        }
        return 'Weiter';
      },
      userOrEmailIsReadonly: function() {
        return this.isLandline || this.isMobile;
      },
      formattedPhonePart: function(){
        var temp = this.user.phonePart.split('');
        temp.splice(2, 0, ' ');
        return temp.join('');
      }
    },
    methods: {
      formOldEmailTryToSend: function() {
        if(this.isUserOrEmailRetrievingData) {
          return;
        }
        if(this.isActiveFormValid) {
          this.api_retrieveMobilePart();
        }
      },
      formRequestSmsTryToSend: function() {
        if(this.isFormRequestSmsRetrievingData) {
          return;
        }
        this.api_requestSmsCode();
      },
      formVerifyTryToSend: function() {
        this.api_verifySmsCode();
      },
      formPassportTryToSend: function() {
        this.api_sendPassportImage();
      },
      formReCreateEmailAndPasswordTryToSend: function() {
        this.api_sendRecreateEmailAndPassword();
      },
      tryToSendForm: function() {
        this[this.activeForm + 'TryToSend']()
      },
      userIdChanged: function( inputId, value ) {
        this.setUserId(value);
        if(this.isActiveFormValid) {
          this.api_retrieveMobilePart()
        }
      },
      switchToLandlineProcess: function() {
        this.removeError();
        this.setLandline();
        document.getElementById('pass').focus();
      },
      handleEnterCase: function(inputId, value, isValid) {
        var self = this;
        this.inputValueChanged(inputId, value, isValid)
          .then(function(){
            self.userIdChanged(inputId, value);
//              self.tryToSendForm();
          })
          .catch(function(err){
            console.log(err);
          });

      },
      imageLoaded: function(image) {
        this.setPassportImage(image);
        this.setImageLoaded();
        this.$nextTick(function(){
          document.getElementById('submit').focus();
        });
      },
      submit: function(){
        console.log('do nothing herer');
      },
      debug: function() {
        this.$route.router.go( {
          name: 'account-recreate'
        } );
      }
    }
  };

</script>