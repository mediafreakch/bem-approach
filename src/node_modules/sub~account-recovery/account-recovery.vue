<style lang="less">

  @keyframes rotating {
    0% {
      transform: rotate(0deg)
    }
    100% {
      transform: rotate(360deg)
    }
  }

  input + .icon {
    display: none;
  }

  .icon.animated,
  .rotating {
    animation: rotating cubic-bezier(1, .5, .4, .5) 1s infinite;
    display: inline-block;
  }

</style>

<template>
  <h1>Account recovery</h1>
  <form>
    <p>In this page you will be able to change the email of your account and you will receive a temporary password:</p>
    <div v-if="!emailChangeConfirmed">
      <r-form-item
          v-on:value-change="form1ValueChange"
          v-on:input-edit="editInput"
          v-on:input-enter="sendForm"
          v-on:input-blur="userIdChanged"
          variant="text"
          label="Current email or username"
          input-id="usernameOrOldEmail"
          type="text"
          validation-type="['required']"
          validation-message="['In order to continue, please enter your current email or username.']"
          icon="spinner"
          v-ref:field1
      ></r-form-item>
      <r-form-item
          @value-change="form1ValueChange"
          @input-edit="editInput"
          @input-enter="sendForm"
          @input-blur=""
          variant="email"
          label="New email"
          input-id="newEmail"
          type="email"
          validation-type="['required', 'email']"
          validation-message="['In order to continue, please enter the new email.', 'Please enter a valid email address.']"
      ></r-form-item>
    </div>

    <div v-if="isForm1Valid && phonePart !== '' && authyId === ''">
      <p>A phone number is associated to this account. To ensure that you are
        the owner of this account, we will send a sms with a code to verify
        this phone number:</p>
      <p><strong>+41 XX XXX {{phonePart}}</strong></p>

    </div>
    <r-alert v-if="errorMessage !== '' && isForm1Valid" type="danger">{{errorMessage}}</r-alert>

    <div v-if="isLandline && isForm1Valid" >
      <r-alert type="info">We could not find a mobile number related to your account. Therefore we need to ask you to scan your ID or passport and upload it, so we can verify your identity:</r-alert>
      <div style="position: relative;">
        <label for="idUpload">Picture of your scanned ID or passport:</label>
        <input type="file" id="idUpload" name="idUpload" style="visibility: hidden; margin-bottom: 15px;" v-model="file"/>
        <p style="position: absolute; top: 33px; padding-right: 150px; box-sizing: border-box;">{{file.split('\\').pop() || 'No file selected yet...'}}</p>
        <label for="idUpload" class="btn btn-link" style="position:absolute; right: 0; top: 21px;">Datei ausw√§hlen</label>
      </div>
    </div>
    <div v-if="isMobile && isForm1Valid && authyId !== '' && !emailChangeConfirmed">
      <p>Please enter the confirmation code we sent you by SMS</p>
      <r-form-item
          @value-change="form2ValueChange"
          @input-edit="editInput"
          @input-enter="sendForm"
          variant="password"
          label="Confirmation code"
          validation-type="['required']"
          validation-message="['In order to proceed, please enter the confirmation code we sent you by SMS.']"
          input-id="confirmationCode"
          type="password"
      ></r-form-item>
    </div>
    <r-alert v-if="emailChangeConfirmed" type="success">
      We successfully changed your email address. Continue in changing the password with this email address:
    </r-alert>
    <button
        @click.prevent="sendForm"
        class="btn btn-primary btn-block"
        v-if="!emailChangeConfirmed"
    >{{wording.button}} <span v-if="buttonLoading" style="font-family: ricardo-icon-font" :class="{'rotating': buttonLoading }">&#xE637;</span>
    </button>
  </form>

</template>

<script>

  var formElements = require( 'element~form-elements' ),
      formItem = formElements.components.formItem,
      alert = require( 'component~alert' );

  module.exports = {
    components: {
      'r-form-item': formItem,
      'r-alert': alert
    },
    data: function() {
      return {
        form1: {
          usernameOrOldEmail: {
            value: '',
            valid: false
          },
          newEmail: {
            value: '',
            valid: false
          }
        },
        form2: {
          confirmationCode: {
            value: '',
            valid: false
          }
        },
        phonePart: '',
        isError: false,
        errorMessage: '',
        authyId: '',
        isLandline: false,
        isMobile: true,
        file: '',
        buttonLoading: false,
        emailChangeConfirmed: false
      }
    },
    computed: {
      isForm1Valid: function() {
        return this.validateForm('form1');
      },
      isForm2Valid: function() {
        return this.validateForm('form2');
      },
      wording: function() {
        return {
          button: this.phonePart !== '' && this.isForm1Valid && !this.emailChangeConfirmed ? (this.authyId === '' ? 'Send code via sms' : 'Confirm') : 'Update account'
        };
      }
    },
    methods: {
      validateForm(form){
        for ( var key in this[form] ) {
          if ( this[form].hasOwnProperty( key ) ) {
            if ( !this[form][ key ].valid ) {
              return false;
            }
          }
        }
        return true;
      },
      form1ValueChange: function( value, valid, id ) {
        this.formValueChange('form1', value, valid, id);
      },
      form2ValueChange: function(value, valid, id) {
        this.formValueChange('form2', value, valid, id);
      },
      formValueChange: function(form, value, valid, id) {
        this[form][id] = {
          value: value,
          valid: valid
        }
      },
      editInput: function() {

      },
      sendForm: function() {

        if ( this.isForm1Valid && this.authyId === '') {
          this.buttonLoading = true;
          return this.$http.post( 'http://localhost:3000/users/'+ encodeURI(this.form1.usernameOrOldEmail.value) + '/phone/request-sms')
              .then ( function success (response) {
                this.buttonLoading = false;
                this.errorMessage = '';
                this.authyId = response.data.body.authyId;
              }, function error (response) {
                this.buttonLoading = false;
                this.errorMessage = response.data.message;
              });
        } else if (this.form2.confirmationCode.value !== '' && !this.emailChangeConfirmed) {
          this.buttonLoading = true;
          return this.$http.post( 'http://localhost:3000/users/'+ encodeURI(this.form1.usernameOrOldEmail.value) + '/phone/verify', {data: {authyId: this.authyId, authyToken: this.form2.confirmationCode.value}})
            .then ( function success (response) {
              this.buttonLoading = false;
              this.errorMessage = '';
              this.emailChangeConfirmed = true;
            }, function error (response) {
              this.buttonLoading = false;
              this.errorMessage = response.data.message;
            });
        } else if (this.emailChangeConfirmed) {
          this.$route.router.go( {
            name: 'forgot-password'
          } );
        } else {
          console.log('');
        }

      },
      goToConfirmationPage: function() {
        this.$route.router.go( {
          name: 'confirm-by-sms-userId',
          params: this.form1.usernameOrOldEmail
        } );
      },
      retrieveMobilePart: function( callback ) {
        this.$refs.field1.animation = true;
        return this.$http.post( 'http://localhost:3000/users/'+ encodeURI(this.form1.usernameOrOldEmail.value) + '/phone/get-mobile-part' )
           .then( function success ( response ) {
             this.errorMessage = '';
             this.phonePart = response.data.body.part;
             this.$refs.field1.animation = false;
             this.isLandline = response.data.body.landline;
             callback();
           }, function error ( response ) {
             this.errorMessage = response.data.message;
             this.$refs.field1.animation = false;
             this.phonePart = '';
           } );
      },
      userIdChanged: function( id ) {

        this.phonePart = '';
        this.retrieveMobilePart( function() {
          if ( this.isForm1Valid ) {
            displayChange();
          }
        } );

      },
      emailChanged: function( id ) {
        if ( this.phonePart !== '' && this.isForm1Valid ) {
          this.displayChange();
        }

      }

    }
  };

</script>