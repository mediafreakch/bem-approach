<template>
  <form>
    <r-form-item
        v-on:value-change="valueChange"
        v-on:input-edit="editInput"
        v-on:input-enter="sendEmail"
        variant="email"
        label="Neue E-Mail-Addresse"
        input-id="email"
        type="email"
        :validation-type="['required', 'email' ]"
        :validation-message="['Bitte füllen Sie dieses Feld aus, um weiterzufahren.', 'Bitte geben Sie eine gültige E-Mail-Addresse ein.' ]"
        :readonly="states.sent"
    ></r-form-item>
    <p class="changeEmail_description">{{activeDescription}}</p>
    <button
        class="btn btn-success btn-block"
        v-if="states.sent"
        disabled="disabled"
    >E-Mail gesendet
    </button>
    <button
        type="submit"
        class="btn btn-primary pull-right"
        v-if="states.edit"
        @click.prevent="sendEmail"
    >E-Mail-Addresse aktualisieren
    </button>
    <button
        v-if="states.edit"
        class="btn btn-secondary"
        v-link="{ path: '/de-ch/user-profile' }"
    >Abbrechen
    </button>
  </form>
</template>

<script>
  var
      formElements = require( 'ricardo-element_form-elements' ),
      icon = require('ricardo-element_icon'),
      utils = require('ricardo-element_utils');

  module.exports = {
    components: {
      'r-form-item': formElements.components.formItem
    },
    data: function() {
      return {
        config: {},
        states: {
          enums: [
            'edit',
            'sent'
          ],
          edit: true,
          sent: false,
          active: 'edit'
        },
        description: {
          edit: 'Wir senden Ihnen einen Bestätigungslink an Ihre neue E-Mail-Adresse.',
          sent: 'Wir haben Ihnen Ihren Bestätigungslink geschickt. Wenn Sie die E-Mail nicht erhalten haben, überprüfen Sie bitte Ihre neue E-Mail-Addresse.'
        },
        value: '',
        validation: {
          valid: 'false'
        }
      }
    },
    computed: {
      activeDescription: function() {
        return this.description[ this.states.active ];
      }
    },
    methods: {
      switchState: function(newState) {
        // reset states
        for(var i = 0; i < this.states.enums.length; i++) {
          this.states[this.states.enums[i]] = false;
        }
        this.states[newState] = true;
        this.states.active = newState;
      },
      valueChange: function(inputID, newValue, isValid) {
        this.value = newValue;
        this.validation.valid = isValid;
      },
      sendEmail: function(){

        if(this.validation.valid) {
          this.$http.post('http://localhost:3000/users/123/email', { data: { email: this.value } })
              .then(function success (response){
                if (response.data.status === 'error') return;

                this.switchState('sent');
                this.value = response.data.data.email;
              }, function error (response) {
                // TODO: show alert message
                console.log('error in sendEmail');
              });
        }
      },
      editInput: function(inputId){
        this.$route.router.go({
          name: 'user-profile',
          params: this.token
        });
      }
    }
  }
</script>
