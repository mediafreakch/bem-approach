<style>
  @import "styles/index.less";
</style>
<template>

  <h1 class="h1">E-Mail-Addresse aktualisieren</h1>

  <form>
    <r-form-item
        v-on:value-change="valueChange"
        v-if="states.edit"
        variant="email"
        label="Neue E-Mail-Addresse"
        input-id="email"
        type="email"
        validation-type="['required', 'email' ]"
        validation-message="['Bitte füllen Sie dieses Feld aus, um weiterzufahren.', 'Bitte geben Sie eine gültige E-Mail-Addresse ein.' ]"
    ></r-form-item>
    <p class="changeEmail_display" v-if="states.sent">{{value}}<span class="icon icon-edit"></span></p>

    <p class="changeEmail_description">{{activeDescription}}</p>

    <button class="btn btn-buy btn-block" v-if="states.sent">E-Mail gesendet</button>
    <button class="btn btn-primary btn-block" v-if="states.edit" v-on:click.prevent="sendEmail">E-Mail-Addresse aktualisieren
    </button>
    <button v-if="states.edit" class="btn btn-default btn-block" v-link="{ path: '/user-profile' }">
      Abbrechen
    </button>
  </form>

  <h3 style="text-align: center; width: 50%; margin: 50px auto; cursor: pointer;" v-link="{ name: 'verify-email-protected', params: { token: 123 } }">Link to the next step</h3>

</template>

<script>

  var
      formElements = require( 'element~form-elements' ),
      icon = require('element~icon');

  module.exports = {
    components: {
      'r-form-item': formElements.components.formItem
    },
    data: function() {
      return {
        config: {},
        states: {
          enum: [
            'edit',
            'sent'
          ],
          edit: true,
          sent: false,
          active: 'edit'
        },
        description: {
          edit: 'Wir senden Ihnen einen Bestätigungslink an Ihre neue E-Mail-Adresse.',
          sent: 'Wir haben Ihnen Ihren Bestätigungslink geschickt. Wenn Sie die E-Mail nicht erhalten haben, überprüfen Sie bitte Ihre neue E-Mail-Addresse.'
        },
        value: ''
      }
    },
    computed: {
      activeDescription: function() {
        return this.description[ this.states.active ];
      }
    },
    methods: {
      switchState: function(newState) {
        // reset states
        for(var i = 0; i < this.states.enum.length; i++) {
          this.states[this.states.enum[i]] = false;
        }
        this.states[newState] = true;
        this.states.active = newState;
      },
      valueChange: function(newValue) {
        this.value = newValue;
      },
      sendEmail: function(){
        this.$http.post('http://localhost:3000/users/123/email', { data: { email: this.value } })
            .then(function success (response){
              this.switchState('sent');
              this.value = response.data.data.email;
              console.log(response);
            }, function error (response) {
              console.log(response);
            });
        console.log(this.value);
      }
    }
  }

</script>
